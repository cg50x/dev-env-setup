
source ../functions

wait_for_apt() {
	local n=1
	local max=60
	local delay=2
	while true; do
		[ -f /var/lib/dpkg/lock ] && break || {
			if [[ $n -lt $max ]]; then
				((n++))
				echo "!!! dpkg is locked! Attempt $n/$max; sleeping for ${delay}s !!!"
				sleep $delay;
			else
				echo "!!! Focing dpkg to unlock !!!"
				$SUDO killall apt-get
				$SUDO killall apt
				$SUDO dkpg --configure -a
				[ -f /var/lib/dpkg/lock ] && fail "!!! dpkg locked after $n attempts !!!"
			fi
		}
	done
}

apt_get_install() {
	wait_for_apt
	$SUDO apt-get install -y "$@"
}

apt_get_update() {
	wait_for_apt
	$SUDO apt-get update
	$SUDO apt-get upgrade
}

